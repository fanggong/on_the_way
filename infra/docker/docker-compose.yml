services:
  postgres:
    image: ${IMAGE_MIRROR_PREFIX:-docker.1ms.run/}library/postgres:17.0
    container_name: otw-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-otw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-otw_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-otw_dev}
      TZ: ${DB_TIMEZONE:-Asia/Shanghai}
      PGTZ: ${DB_TIMEZONE:-Asia/Shanghai}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-otw} -d ${POSTGRES_DB:-otw_dev}"]
      interval: 10s
      timeout: 5s
      retries: 10

  api-service:
    build:
      context: ../../services/api
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        ALL_PROXY: ${ALL_PROXY:-}
    container_name: otw-api
    environment:
      APP_ENV: ${APP_ENV:-dev}
      API_PORT: ${API_PORT:-8000}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://otw:otw_dev_password@postgres:5432/otw_dev}
      REQUEST_FUTURE_TOLERANCE_MINUTES: ${REQUEST_FUTURE_TOLERANCE_MINUTES:-5}
      GARMIN_EMAIL: ${GARMIN_EMAIL:-}
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:8000/v1/health/live', timeout=5).status==200 else 1)\""]
      interval: 10s
      timeout: 5s
      retries: 10

  connector-worker:
    build:
      context: ../../services/connector-worker
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        ALL_PROXY: ${ALL_PROXY:-}
    container_name: otw-connector
    environment:
      API_BASE_URL: ${CONNECTOR_API_BASE_URL:-http://api-service:8000}
      CONNECTOR_INGEST_PATH: ${CONNECTOR_INGEST_PATH:-/v1/ingest/connector-health}
      CONNECTOR_INTERVAL_SECONDS: ${CONNECTOR_INTERVAL_SECONDS:-3600}
      CONNECTOR_VERSION: ${CONNECTOR_VERSION:-v0.3.1}
      CONNECTOR_REQUEST_TIMEOUT_SECONDS: ${CONNECTOR_REQUEST_TIMEOUT_SECONDS:-10}
      CONNECTOR_RETRY_ATTEMPTS: ${CONNECTOR_RETRY_ATTEMPTS:-3}
      GARMIN_EMAIL: ${GARMIN_EMAIL:-}
      GARMIN_PASSWORD: ${GARMIN_PASSWORD:-}
      GARMIN_TOKEN_DIR: ${GARMIN_TOKEN_DIR:-/tmp/.garminconnect}
      GARMIN_FETCH_WINDOW_DAYS: ${GARMIN_FETCH_WINDOW_DAYS:-3}
      GARMIN_BACKFILL_DAYS: ${GARMIN_BACKFILL_DAYS:-10}
      GARMIN_METRICS: ${GARMIN_METRICS:-all}
      GARMIN_TIMEZONE: ${GARMIN_TIMEZONE:-Asia/Shanghai}
      GARMIN_IS_CN: ${GARMIN_IS_CN:-true}
      GARMIN_MFA_CODE: ${GARMIN_MFA_CODE:-}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://otw:otw_dev_password@postgres:5432/otw_dev}
    depends_on:
      api-service:
        condition: service_healthy
      postgres:
        condition: service_healthy

  dbt-runner:
    build:
      context: ../../data/dbt
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        ALL_PROXY: ${ALL_PROXY:-}
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://pypi.org/simple}
    container_name: otw-dbt
    working_dir: /usr/app
    volumes:
      - ../../data/dbt:/usr/app
    environment:
      DBT_PROFILES_DIR: /usr/app
      DBT_DB_HOST: postgres
      DBT_DB_PORT: 5432
      DBT_DB_USER: ${POSTGRES_USER:-otw}
      DBT_DB_PASSWORD: ${POSTGRES_PASSWORD:-otw_dev_password}
      DBT_DB_NAME: ${POSTGRES_DB:-otw_dev}
      DBT_BUILD_INTERVAL_SECONDS: ${DBT_BUILD_INTERVAL_SECONDS:-300}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      HTTP_PROXY: ${HTTP_PROXY:-}
      ALL_PROXY: ${ALL_PROXY:-}
    command:
      - sh
      - -c
      - |
        while true; do
          dbt build --target dev && date -u +"%Y-%m-%dT%H:%M:%SZ" > /tmp/dbt_last_success;
          sleep ${DBT_BUILD_INTERVAL_SECONDS};
        done
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/dbt_last_success"]
      interval: 20s
      timeout: 5s
      retries: 10

  openmetadata-db:
    image: ${IMAGE_MIRROR_PREFIX:-docker.1ms.run/}library/mysql:8.4
    container_name: otw-openmetadata-db
    environment:
      MYSQL_ROOT_PASSWORD: ${OM_DB_ROOT_PASSWORD:-openmetadata_root_password}
      MYSQL_USER: ${OM_DB_USER:-openmetadata_user}
      MYSQL_PASSWORD: ${OM_DB_PASSWORD:-openmetadata_password}
      MYSQL_DATABASE: ${OM_DB_NAME:-openmetadata_db}
    volumes:
      - openmetadata_db_data_v2:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u${OM_DB_USER:-openmetadata_user} -p${OM_DB_PASSWORD:-openmetadata_password}"]
      interval: 10s
      timeout: 5s
      retries: 20

  openmetadata-search:
    image: ${IMAGE_MIRROR_PREFIX:-docker.1ms.run/}library/elasticsearch:8.15.2
    container_name: otw-openmetadata-search
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: -Xms1g -Xmx1g
    volumes:
      - openmetadata_search_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health >/dev/null"]
      interval: 20s
      timeout: 10s
      retries: 20

  openmetadata-server:
    image: ${IMAGE_MIRROR_PREFIX:-docker.1ms.run/}openmetadata/server:${OPENMETADATA_VERSION:-1.11.10}
    container_name: otw-openmetadata
    env_file:
      - ./openmetadata/.env
    ports:
      - "${OPENMETADATA_PORT:-8585}:8585"
    depends_on:
      openmetadata-db:
        condition: service_healthy
      openmetadata-search:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'cat </dev/null >/dev/tcp/localhost/8585'"]
      interval: 20s
      timeout: 10s
      retries: 20

  openmetadata-ingestion:
    image: ${IMAGE_MIRROR_PREFIX:-docker.1ms.run/}openmetadata/ingestion:${OPENMETADATA_VERSION:-1.11.10}
    container_name: otw-openmetadata-ingestion
    volumes:
      - ./openmetadata/ingestion:/opt/airflow/ingestion
      - ../../data/dbt:/data/dbt
    environment:
      AIRFLOW__API__AUTH_BACKENDS: airflow.api.auth.backend.basic_auth
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: mysql+pymysql://${OM_DB_USER:-openmetadata_user}:${OM_DB_PASSWORD:-openmetadata_password}@openmetadata-db:3306/${OM_DB_NAME:-openmetadata_db}
      OPENMETADATA_SERVER_URL: http://openmetadata-server:8585/api
    depends_on:
      openmetadata-server:
        condition: service_healthy

volumes:
  postgres_data:
  openmetadata_db_data_v2:
  openmetadata_search_data:
