# 交付物启动与验收说明 v0.3.1

适用目录: `/Users/fangyongchao/Projects/on_the_way`

本文聚焦 `v0.3.1`：
- 健康链路 `raw -> canonical -> domain_health -> mart`
- POC (`poc_signal`) 退役
- OpenMetadata 注释与可见性治理

版本状态: `已验收（已完成）`（2026-02-27）

---

## 1. 版本范围

v0.3.1 新增/变更：
- 新增 Canonical 健康模型：
  - `canonical.health_event`
  - `canonical.health_metric_daily`
  - `canonical.health_activity_event`
- 新增 Domain 健康模型：
  - `domain_health.health_metric_daily_fact`
  - `domain_health.health_activity_event_fact`
- 新增 Mart 健康模型（统一 `mart` schema）：
  - `mart.health_metric_daily_summary`
  - `mart.health_daily_overview`
  - `mart.health_activity_topic_daily`
- 退役 POC API 与 POC schema：
  - `domain_poc_signal`
  - `mart_poc_signal`
- 更新 OpenMetadata ingestion schema 范围。

v0.3.1 已退役：
- `POST /v1/ingest/manual-signal`
- `POST /v1/ingest/connector-signal`
- `GET /v1/poc/signals`
- `GET /v1/poc/daily-summary`

---

## 2. 启动步骤

```bash
cd /Users/fangyongchao/Projects/on_the_way
cp infra/docker/.env.example infra/docker/.env  # 首次执行

# 补齐 Garmin 凭据后启动
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env up -d --build
```

检查服务：

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env ps
curl -fsS http://localhost:8000/v1/health/live
curl -fsS http://localhost:8000/v1/health/connector
```

---

## 3. 一键验收脚本

```bash
bash scripts/dev/verify_v0_3_1.sh
```

脚本覆盖：
- 服务存活
- `connector-health` 写入与幂等重放
- dbt build（含 `domain_health` 与 `mart`）
- Canonical/Domain/Mart 表产数与关键一致性
- POC schema 与历史数据清理
- OpenMetadata 表可见性（`health_metric_daily_summary`）
- OpenMetadata 遗留元数据清理验证（`domain_poc_signal`、`mart_poc_signal`、`mart_health`）

---

## 4. 手工验收 SQL

### 4.1 健康链路行数检查

```sql
select
  (select count(*) from raw.raw_event where source_id = 'garmin_connect_health') as raw_cnt,
  (select count(*) from canonical.health_event) as canonical_event_cnt,
  (select count(*) from canonical.health_metric_daily) as canonical_metric_cnt,
  (select count(*) from canonical.health_activity_event) as canonical_activity_cnt,
  (select count(*) from domain_health.health_metric_daily_fact) as domain_metric_fact_cnt,
  (select count(*) from domain_health.health_activity_event_fact) as domain_activity_fact_cnt,
  (select count(*) from mart.health_metric_daily_summary) as mart_metric_summary_cnt,
  (select count(*) from mart.health_daily_overview) as mart_daily_overview_cnt,
  (select count(*) from mart.health_activity_topic_daily) as mart_activity_topic_cnt;
```

### 4.2 Mart 主键粒度重复检查

```sql
select account_ref, stat_date, metric_name, count(*) as dup_cnt
from mart.health_metric_daily_summary
group by 1,2,3
having count(*) > 1;
```

```sql
select account_ref, stat_date, activity_type, count(*) as dup_cnt
from mart.health_activity_topic_daily
group by 1,2,3
having count(*) > 1;
```

通过标准：以上 SQL 返回 0 行。

### 4.3 POC schema 删除验证

```sql
select schema_name
from information_schema.schemata
where schema_name in ('domain_poc_signal', 'mart_poc_signal');
```

通过标准：返回 0 行。

### 4.4 POC 数据清理验证

```sql
select count(*) as poc_raw_cnt
from raw.raw_event
where source_id in ('ios_manual', 'signal_random_connector');
```

```sql
select count(*) as poc_audit_cnt
from app.request_audit
where source_id in ('ios_manual', 'signal_random_connector');
```

```sql
select count(*) as poc_annotation_cnt
from annotation.annotation
where target_type = 'signal_event';
```

通过标准：以上计数均为 0。

### 4.5 活动主题表产数检查

```sql
select
  activity_type,
  count(*) as row_cnt,
  sum(activity_count) as activity_cnt
from mart.health_activity_topic_daily
group by 1
order by 1;
```

通过标准：
- 表有产数。
- 如原始数据存在骑行，则可见 Garmin 原始类型（如 `road_biking`、`indoor_cycling`）有记录。

### 4.6 活动主题占位字段建表检查

```sql
select column_name
from information_schema.columns
where table_schema = 'mart'
  and table_name = 'health_activity_topic_daily'
  and column_name in (
    'moving_seconds_sum',
    'elapsed_seconds_sum',
    'avg_speed_mps_avg',
    'max_speed_mps_max',
    'avg_cadence_rpm_avg',
    'max_cadence_rpm_max',
    'avg_power_watts_avg',
    'max_power_watts_max',
    'normalized_power_watts_avg',
    'training_effect_aerobic_avg',
    'training_effect_anaerobic_avg',
    'training_load_sum',
    'steps_count_sum',
    'lap_count_sum',
    'avg_temperature_c_avg',
    'max_temperature_c_max',
    'route_covered_count',
    'gear_used_count'
  )
order by 1;
```

通过标准：返回字段数等于 `18`。

### 4.7 表/字段注释缺失检查

```sql
select n.nspname as schema_name, c.relname as table_name
from pg_class c
join pg_namespace n on n.oid = c.relnamespace
where n.nspname in ('raw','canonical','domain_health','mart','annotation','app')
  and c.relkind in ('r','v','m')
  and coalesce(obj_description(c.oid, 'pg_class'), '') = ''
order by 1,2;
```

```sql
select
  n.nspname as schema_name,
  c.relname as table_name,
  a.attname as column_name
from pg_attribute a
join pg_class c on c.oid = a.attrelid
join pg_namespace n on n.oid = c.relnamespace
where n.nspname in ('raw','canonical','domain_health','mart','annotation','app')
  and c.relkind in ('r','v','m')
  and a.attnum > 0
  and not a.attisdropped
  and coalesce(col_description(a.attrelid, a.attnum), '') = ''
order by 1,2,3;
```

通过标准：以上两条 SQL 均返回 0 行。

### 4.8 `account_ref` 一致性检查（单账号部署）

```sql
select payload_json ->> 'account_ref' as account_ref, count(*) as cnt
from raw.raw_event
where source_id = 'garmin_connect_health'
group by 1
order by cnt desc;
```

```sql
select account_ref, count(*) as cnt
from canonical.health_event
group by 1
order by cnt desc;
```

```sql
select account_ref, count(*) as cnt
from domain_health.health_metric_daily_fact
group by 1
order by cnt desc;
```

```sql
select account_ref, count(*) as cnt
from mart.health_daily_overview
group by 1
order by cnt desc;
```

通过标准（单账号场景）：
- 四条 SQL 均仅返回 1 个 `account_ref`。

---

## 5. OpenMetadata 验收

执行：

```bash
bash scripts/dev/run_openmetadata_ingestion.sh
```

检查点：
- 能检索到 `mart.health_metric_daily_summary`
- 能检索到 `canonical.health_event`
- 能看到表级/字段级描述
- 不能再检索到 `domain_poc_signal`、`mart_poc_signal` 对应实体
- 不存在 FQN 包含 `.mart_health.` 的遗留表实体

---

## 6. 关联文档

- 产品文档：`docs/product/product_v0.3.1.md`
- API 文档：`docs/api/api_v0.3.1.md`
- v0.3.0 运行说明（历史）：`docs/run/交付物启动与验收说明_v0.3.0.md`

---

## 7. 收尾记录（2026-02-27）

1. 已执行并通过：`bash scripts/dev/run_openmetadata_ingestion.sh`
2. 已执行并通过：`bash scripts/dev/verify_v0_3_1.sh`
3. OpenMetadata 复核结论：
   - `domain_poc_signal` 检索结果 `hits=0`
   - `mart_poc_signal` 检索结果 `hits=0`
   - FQN 严格扫描 `poc_signal/.mart_health.` 残留 `hits=0`
