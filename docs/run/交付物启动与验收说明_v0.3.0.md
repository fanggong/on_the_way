# 交付物启动与验收说明 v0.3.0

适用目录: `/Users/fangyongchao/Projects/on_the_way`

本文聚焦 `v0.3.0` 后端研发范围：Garmin Connect 健康连接器写入 Raw。  
`v0.1.0` 全链路基线见 `docs/run/交付物启动与验收说明_v0.1.0.md`。

---

## 1. 版本范围

v0.3.0 本次新增：
- 健康连接器（Garmin Connect）
- 新增接口 `POST /v1/ingest/connector-health`
- Raw 入库与幂等处理

v0.3.0 不包含：
- `domain_health` / `mart_health` 建模
- iOS 健康页与可视化页面

---

## 2. 研发前准备

### 2.1 环境变量

在 `infra/docker/.env` 增加并确认以下变量（开发环境）：

```env
GARMIN_EMAIL=<your garmin email>
GARMIN_PASSWORD=<your garmin password>
GARMIN_TOKEN_DIR=/tmp/.garminconnect
GARMIN_FETCH_WINDOW_DAYS=3
GARMIN_BACKFILL_DAYS=10
GARMIN_METRICS=all
GARMIN_TIMEZONE=Asia/Shanghai
GARMIN_IS_CN=true
CONNECTOR_INTERVAL_SECONDS=3600
```

安全要求：
- `.env` 不入库；不把真实账号密码写入任何文档或代码。
- 日志不打印 `GARMIN_PASSWORD`、token、cookie。

### 2.2 服务清单

后端联调最小服务：
- `postgres`
- `api-service`
- `connector-worker`

推荐仍使用完整 compose，避免后续回归重复启动。

---

## 3. 启动步骤

### 3.1 启动容器

```bash
cd /Users/fangyongchao/Projects/on_the_way
cp infra/docker/.env.example infra/docker/.env  # 首次执行
# 手动补充 Garmin 变量后

docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env up -d --build
```

### 3.2 检查服务状态

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env ps
curl -fsS http://localhost:8000/v1/health/live
curl -fsS http://localhost:8000/v1/health/connector
```

---

## 4. 开发联调检查（后端）

### 4.1 API 契约检查

使用 `docs/api/api_v0.3.0.md` 的示例请求，验证：
- `POST /v1/ingest/connector-health` 返回 `200`
- 重复请求返回 `idempotent=true`
- 同 `source_id+external_id` 不同 payload 返回 `409`

### 4.2 连接器行为检查

必须验证以下行为：
1. 首次登录可完成（含 MFA 场景）。
2. 按全量数据集循环采集，单项失败不拖垮整轮。
3. `no_data/not_supported` 仅记录日志，不写 Raw，不计硬失败。
4. API 临时失败会重试，并在后续轮次恢复。

---

## 5. 数据验收 SQL

### 5.1 Garmin 数据入库总量

```sql
select count(*) as cnt
from raw.raw_event
where source_id = 'garmin_connect_health';
```

### 5.2 按数据集统计

```sql
select
  payload_json ->> 'metric_type' as metric_type,
  count(*) as cnt,
  min(occurred_at) as min_occurred_at,
  max(occurred_at) as max_occurred_at
from raw.raw_event
where source_id = 'garmin_connect_health'
group by 1
order by 1;
```

### 5.3 默认回填窗口检查（10天）

```sql
select
  min((payload_json ->> 'metric_date')::date) as min_metric_date,
  max((payload_json ->> 'metric_date')::date) as max_metric_date
from raw.raw_event
where source_id = 'garmin_connect_health';
```

通过标准：
- `min_metric_date` 至少覆盖当前日期往前约 `10` 天。

### 5.4 可选：一次性历史全量回填（按设备启用日期）

当需要从指定历史日期做一次性全量回填时：

1. 临时调整 `GARMIN_BACKFILL_DAYS` 到目标跨度天数（例如从设备启用日到今天）。
2. 删除回填标记：`/tmp/.garminconnect/.backfill_done`。
3. 重启 `connector-worker`，等待一轮 `cycle finished`。
4. 回填完成后将 `GARMIN_BACKFILL_DAYS` 改回 `10`，并确保标记文件存在，避免重复大回填。

---

## 6. 回归检查（必须）

v0.3.0 不得破坏 v0.1.0 既有路径：

```bash
curl -fsS http://localhost:8000/v1/health/live
curl -fsS http://localhost:8000/v1/health/connector

# 手工录入与随机连接器接口仍可调用
curl -sS -X POST "http://localhost:8000/v1/ingest/manual-signal" -H "Content-Type: application/json" -d '{"source_id":"ios_manual","external_id":"regression-manual-001","occurred_at":"2026-02-26T10:00:00+08:00","payload":{"value":50.1,"note":"regression"}}'

curl -sS -X POST "http://localhost:8000/v1/ingest/connector-signal" -H "Content-Type: application/json" -d '{"source_id":"signal_random_connector","external_id":"regression-connector-001","occurred_at":"2026-02-26T10:00:00+08:00","payload":{"value":40.2,"seed":"regression-seed","generator_version":"v1"}}'
```

---

## 7. 交付完成判定（v0.3.0）

以下全部满足即判定后端交付可进入下阶段：
1. `connector-health` API 按契约可用。
2. Garmin 全量数据集采集流程可执行，且具备容错。
3. Raw 层有稳定写入且幂等规则正确。
4. 安全检查通过（无明文凭据日志/入库）。
5. v0.1.0 接口回归通过。

---

## 8. 关联文档

- 产品文档：`docs/product/product_v0.3.0.md`
- API 文档：`docs/api/api_v0.3.0.md`
- v0.1.0 全量运行说明：`docs/run/交付物启动与验收说明_v0.1.0.md`
