# 交付物启动与验收说明 v0.1.0

适用目录: `/Users/fangyongchao/Projects/on_the_way`

本文说明两件事:
- 如何启动 v0.1.0 的所有交付物
- 如何验证它们已正确启动

---

## 1. 交付物清单

v0.1.0 包含以下可运行交付物:

- 数据与服务运行体（Docker）
  - `postgres`
  - `api-service`（FastAPI）
  - `connector-worker`（随机信号连接器）
  - `dbt-runner`
- 元数据治理（Docker）
  - `openmetadata-db`（MySQL）
  - `openmetadata-search`（Elasticsearch）
  - `openmetadata-server`
  - `openmetadata-ingestion`（按需执行）
- iOS 客户端（React Native + 原生 iOS 工程）
  - `apps/ios/ios/OnTheWayIOS.xcodeproj`

---

## 2. 前置条件

请先确认本机已安装:

- Docker Desktop（已启动）
- Node.js 与 npm（建议 Node >= 18）
- Xcode（用于 iOS 模拟器/真机）
- CocoaPods（用于 iOS Pods，推荐 `brew install cocoapods`）

---

## 3. 启动所有交付物

### 3.1 一次性准备

在项目根目录执行:

```bash
cd /Users/fangyongchao/Projects/on_the_way
cp infra/docker/.env.example infra/docker/.env
```

如果你走代理/VPN，可先导出:

```bash
export https_proxy=http://127.0.0.1:7890
export http_proxy=http://127.0.0.1:7890
export all_proxy=socks5://127.0.0.1:7890
```

如镜像拉取不稳定，可在 `infra/docker/.env` 确认:

```env
IMAGE_MIRROR_PREFIX=docker.1ms.run/
```

### 3.2 启动后端与数据平台（推荐全量）

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env up -d --build
```

这一步会启动:
- `postgres`
- `api-service`
- `connector-worker`
- `dbt-runner`
- `openmetadata-db`
- `openmetadata-search`
- `openmetadata-server`

### 3.3 导入 OpenMetadata 元数据与血缘

```bash
bash scripts/dev/run_openmetadata_ingestion.sh
```

该脚本会执行:
- 登录 OpenMetadata 获取 JWT
- 导入 Postgres 元数据
- 生成 dbt docs
- 导入 dbt 元数据与 lineage

### 3.4 启动 iOS 客户端

终端 A:

```bash
cd /Users/fangyongchao/Projects/on_the_way/apps/ios
npm install
npm run pods
npm start
```

终端 B:

```bash
cd /Users/fangyongchao/Projects/on_the_way/apps/ios
open -a Simulator
npm run ios -- --simulator "iPhone 17"
```

说明:
- 模拟器内 `http://localhost:8000` 可直连本机 API。
- 如机型名不一致，可先查询:

```bash
xcrun simctl list devices available
```

---

## 4. 如何验证已正确启动

## 4.1 一键总验收（最推荐）

回到项目根目录执行:

```bash
cd /Users/fangyongchao/Projects/on_the_way
bash scripts/dev/verify_v0_1_0.sh
```

成功标准:
- 最后一行输出 `verify_v0_1_0 passed`
- 过程中关键项均为 `[PASS]`

---

## 4.2 分交付物逐项验收

### A. Docker 服务状态

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env ps
```

成功标准:
- 下列服务处于 `Up`（含 healthy/starting 皆可接受短暂过渡）:
  - `otw-postgres`
  - `otw-api`
  - `otw-connector`
  - `otw-dbt`
  - `otw-openmetadata-db`
  - `otw-openmetadata-search`
  - `otw-openmetadata`

### B. API 健康检查

```bash
curl -fsS http://localhost:8000/v1/health/live
```

成功标准:
- 返回 200 且有 JSON 响应

### C. 手工录入链路（P1）

```bash
curl -sS -X POST "http://localhost:8000/v1/ingest/manual-signal" \
  -H "Content-Type: application/json" \
  -d '{
    "source_id":"ios_manual",
    "external_id":"ios-manual-test-001",
    "occurred_at":"2026-02-25T10:30:00Z",
    "payload":{"value":66.6,"note":"manual verify"}
  }'
```

成功标准:
- 返回包含 `status: ok`、`raw_id`、`idempotent`

### D. 连接器写入链路（P2）

```bash
curl -sS -X POST "http://localhost:8000/v1/ingest/connector-signal" \
  -H "Content-Type: application/json" \
  -d '{
    "source_id":"signal_random_connector",
    "external_id":"connector-test-001",
    "occurred_at":"2026-02-25T10:35:00Z",
    "payload":{"value":42.4,"seed":"verify-seed","generator_version":"v1"}
  }'
```

成功标准:
- 返回 200 且 `status: ok`

### E. dbt 产数验证

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env exec -T dbt-runner dbt build --target dev
```

成功标准:
- 命令退出码为 0

检查 Domain/Mart 是否有数据:

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env exec -T postgres \
  psql -U otw -d otw_dev -Atc "select count(*) from domain_poc_signal.signal_event;"

docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env exec -T postgres \
  psql -U otw -d otw_dev -Atc "select count(*) from mart_poc_signal.signal_daily_summary;"
```

成功标准:
- 两个计数均大于 0

### F. 连接器健康接口

```bash
curl -fsS http://localhost:8000/v1/health/connector
```

成功标准:
- 返回 200

### G. OpenMetadata 可达性

```bash
curl -fsS http://localhost:8585/api/v1/system/version
```

成功标准:
- 返回版本信息 JSON

### H. OpenMetadata 表/血缘可见性

先登录拿 token（密码需要 base64）:

```bash
OM_TOKEN=$(curl -sS -X POST "http://localhost:8585/api/v1/users/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@open-metadata.org","password":"YWRtaW4="}' \
  | python3 -c 'import json,sys;print(json.load(sys.stdin)["accessToken"])')
```

再查表:

```bash
curl -fsS -H "Authorization: Bearer ${OM_TOKEN}" \
  "http://localhost:8585/api/v1/search/query?q=signal_daily_summary&index=table"
```

成功标准:
- 返回结果中可检索到 `signal_daily_summary`（前提是已执行 ingestion 脚本）

### I. iOS 客户端功能验收

在模拟器 App 中验证:
- 「手工录入」页提交成功，看到成功状态
- 「结果查看」页按当天日期查询，能看到 `event_count/manual_count/connector_count`

如手工录入成功但查询为空，通常是 `dbt-runner` 尚未到下一轮 build，可手动执行一次:

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env exec -T dbt-runner dbt build --target dev
```

---

## 5. 常见问题

### 5.1 镜像拉取失败/超时

- 先设置代理环境变量（见 3.1）
- 确认 `IMAGE_MIRROR_PREFIX=docker.1ms.run/`
- 重试 `docker compose ... up -d --build`

### 5.2 端口冲突

- PostgreSQL 宿主端口由 `infra/docker/.env` 的 `POSTGRES_PORT` 控制（例如 `55432`）
- API 端口由 `API_PORT` 控制（默认 `8000`）
- OpenMetadata 端口由 `OPENMETADATA_PORT` 控制（默认 `8585`）

### 5.3 iOS Pods 安装失败

先确保 CocoaPods 可用:

```bash
brew install cocoapods
```

然后在 `apps/ios` 执行:

```bash
npm run pods
```

### 5.4 OpenMetadata 401

- `v0.1.0` 已使用登录鉴权（basic/openmetadata）
- 验证时需先登录拿 `Bearer token`（见 4.2-H）

---

## 6. 停止与清理

停止容器:

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env down
```

连同数据卷清理（危险，会清空本地数据）:

```bash
docker compose -f infra/docker/docker-compose.yml --env-file infra/docker/.env down -v
```

补充说明:
- `dbt-runner` 运行时会持续生成 `data/dbt/target`、`data/dbt/logs`、`data/dbt/.user.yml`，这些均为运行产物，已在 `.gitignore` 中忽略。
